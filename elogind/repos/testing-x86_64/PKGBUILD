# Maintainer: artoo <artoo@artixlinux.org>

pkgbase=elogind
pkgname=('elogind' 'libelogind')
pkgver=241.1
pkgrel=5
pkgdesc="The systemd project's logind, extracted to a standalone package"
arch=('x86_64')
url="https://github.com/elogind/elogind"
license=('GPL' 'LGPL2.1')
makedepends=('intltool' 'libtool' 'gperf' 'gtk-doc' 'polkit' 'dbus' 'eudev'
            'libseccomp' 'meson' 'kexec-tools' 'artix-sysvcompat')
options=('!libtool')
source=("${pkgbase}-${pkgver}.tar.gz::https://github.com/elogind/elogind/archive/v${pkgver}.tar.gz")
sha256sums=('ded3d19dc4b91564b920bae472656a8664f86868fa3edb0554e856e6a8377712')

prepare() {
    cd ${pkgbase}-${pkgver}
}

build() {
    local meson_options=(
        -Drootlibdir=/usr/lib
        -Drootlibexecdir=/usr/lib/elogind
        -Ddbuspolicydir=/usr/share/dbus-1/system.d
        -Ddocdir=/usr/share/doc/elogind
        -Ddefault-hierarchy=hybrid
        -Dcgroup-controller=openrc
#         -Ddefault-kill-user-processes=false
    )

    arch-meson "$pkgbase-${pkgver}" build "${meson_options[@]}"

    ninja -C build
}

check(){
    meson test -C build
}

package_elogind() {
    pkgdesc="The systemd project's logind, extracted to a standalone package"
    groups=('base')
    provides=("elogind=${pkgver}" 'systemd-dummy' 
            "systemd=${pkgver}" "systemd-tools=${pkgver}")
    conflicts=('systemd-dummy' 'systemd')
    replaces=('systemd-dummy')
    depends=('acl' 'pam' 'dbus' 'eudev' 'libseccomp' 'libelogind' 'kexec-tools' 'artix-sysvcompat')
    optdepends=('polkit: polkit support')
    backup=('etc/elogind/logind.conf')

    DESTDIR="$pkgdir" meson install -C build
    
    mkdir ${srcdir}/_libelogind
    mv -v ${pkgdir}/usr/lib/pkgconfig ${srcdir}/_libelogind
    mv -v ${pkgdir}/usr/include/ ${srcdir}/_libelogind
    mv -v ${pkgdir}/usr/lib/libelogind*.so* ${srcdir}/_libelogind
}

package_libelogind(){
    pkgdesc="elogind client libraries"
    groups=('base-devel')
    provides=('libelogind.so' "libelogind=${pkgver}" 'systemd-libs-dummy'
            "libsystemd=${pkgver}" "systemd-libs=${pkgver}"
            'libsystemd.so' 'libelogind.so')
    conflicts=('systemd-libs-dummy' 'systemd-libs')
    replaces=('systemd-libs-dummy')
    depends=('libcap' 'libeudev')

    cd ${pkgbase}-${pkgver}

    install -dm755 ${pkgdir}/usr/lib
    mv ${srcdir}/_libelogind/include ${pkgdir}/usr
    mv ${srcdir}/_libelogind/pkgconfig ${pkgdir}/usr/lib
    mv ${srcdir}/_libelogind/libelogind*.so* ${pkgdir}/usr/lib
    
    ln -sfv libelogind.so ${pkgdir}/usr/lib/libsystemd.so
    ln -sfv libsystemd.so ${pkgdir}/usr/lib/libsystemd.so.0
#     ln -sfv libelogind.pc ${pkgdir}/usr/lib/pkgconfig/libsystemd.pc
}
